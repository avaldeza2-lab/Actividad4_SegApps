name: CI/CD

on:
  push:
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (app + dev)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          if [ -f dev-requirements.txt ]; then python -m pip install -r dev-requirements.txt; fi

      - name: Run tests (pytest)
        run: |
          if [ -f pytest.ini ] || ls -1 tests/*.py 2>/dev/null; then pytest -q; else echo "No tests, skipping"; fi

      - name: Static analysis (Bandit)
        run: |
          python -m pip install bandit || true
          python -m bandit -r . -ll --exclude venv,tests || true

      - name: Dependency audit (pip-audit)
        run: |
          python -m pip install pip-audit || true
          python -m pip_audit || true

  deploy:
    needs: ci
    if: github.ref == 'refs/heads/main'
    runs-on: self-hosted   # <- tu runner en Ubuntu

    env:
      APP_DIR: /opt/secure-app
      SERVICE_NAME: secure-app
      MODULE: AppSegApps:app         # mÃ³dulo:objeto Flask dentro de tu app
      BIND: 127.0.0.1:8000
      WORKERS: "2"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Sync code to $APP_DIR
        run: |
          mkdir -p "$APP_DIR"
          rsync -az --delete --exclude ".git" ./ "$APP_DIR/"

      - name: Create/Update systemd service
        run: |
          sudo bash -c 'cat > /etc/systemd/system/${SERVICE_NAME}.service <<EOF
          [Unit]
          Description=Secure Flask App (Gunicorn)
          After=network.target

          [Service]
          User=${USER}
          WorkingDirectory=${APP_DIR}
          Environment="PATH=${APP_DIR}/.venv/bin"
          ExecStart=${APP_DIR}/.venv/bin/gunicorn -w ${WORKERS} -b ${BIND} ${MODULE}
          Restart=always

          [Install]
          WantedBy=multi-user.target
          EOF'
          sudo systemctl daemon-reload

      - name: Create venv & install runtime deps
        run: |
          python3 -m venv "${APP_DIR}/.venv" || true
          . "${APP_DIR}/.venv/bin/activate"
          python -m pip install --upgrade pip
          if [ -f "${APP_DIR}/requirements.txt" ]; then pip install -r "${APP_DIR}/requirements.txt"; fi
          pip install gunicorn

      - name: Enable & restart service
        run: |
          sudo systemctl enable "${SERVICE_NAME}"
          sudo systemctl restart "${SERVICE_NAME}"
          systemctl --no-pager --full status "${SERVICE_NAME}" | head -n 30

      - name: Health check (local)
        run: |
          curl -sSf "http://127.0.0.1:8000/" | head -n 5 || (journalctl -u "${SERVICE_NAME}" -e --no-pager; exit 1)
